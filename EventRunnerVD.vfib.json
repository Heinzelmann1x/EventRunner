{"name":"EventRunnerVD","type":"virtual_device","properties":{"deviceIcon":0,"currentIcon":"0","log":"","logTemp":"","mainLoop":"","ui.CMD.value":"window:on","ui.SCENE.value":"Tester:13","visible":"true","rows":[{"type":"label","elements":[{"id":1,"lua":false,"waitForResponse":false,"caption":"Scene:","name":"SCENE","favourite":false,"main":false}]},{"type":"button","elements":[{"id":2,"lua":true,"waitForResponse":false,"caption":"&lt;&lt;","name":"PrevScene","empty":false,"msg":"EVC=\"EVVDVAR\"\nselfID=fibaro:getSelfId()\nif not string.find(json.encode((api.get(\"/globalVariables/\"))),\"\\\"\"..EVC..\"\\\"\") then\n  api.post(\"/globalVariables/\",{name=EVC}) \nend\nconfig=fibaro:getGlobal(EVC)\nconfig = config or \"\"\nconfig = config~=\"\" and config or \"[]\"\n\nscenes=json.decode(config)\n\nscene = fibaro:getValue(selfID,\"ui.SCENE.value\")\nid = tonumber(scene:match(\":(%d+)\"))\nfibaro:debug(\"S:\"..scene)\nif #scenes > 0 then\n  for i=#scenes,1,-1 do\n    fibaro:debug(scenes[i].id..\" \"..id)\n\tif scenes[i].id==id then\n      i=i-1\n      i=i==0 and #scenes or i\n      fibaro:debug(\"I:\"..i)\n      fibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",scenes[i].name..\":\"..scenes[i].id)\n      fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",scenes[i].cmds[1] or \"<NONE>\")\n      return\n    end\n  end\nend\nfibaro:debug(\"OK\")\nfibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",\"<NONE>\")\nfibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",\"<NONE>\")\n","buttonIcon":0,"favourite":false,"main":false},{"id":3,"lua":true,"waitForResponse":false,"caption":"&gt;&gt;","name":"Button12","empty":false,"msg":"EVC=\"EVVDVAR\"\nselfID=fibaro:getSelfId()\nif not string.find(json.encode((api.get(\"/globalVariables/\"))),\"\\\"\"..EVC..\"\\\"\") then\n  api.post(\"/globalVariables/\",{name=EVC}) \nend\nconfig=fibaro:getGlobal(EVC)\nconfig = config or \"\"\nconfig = config~=\"\" and config or \"[]\"\n\nscenes=json.decode(config)\n\nscene = fibaro:getValue(selfID,\"ui.SCENE.value\")\nid = tonumber(scene:match(\":(%d+)\"))\nfibaro:debug(\"S:\"..scene)\nif #scenes > 0 then\n  for i=1,#scenes do\n    fibaro:debug(scenes[i].id..\" \"..id)\n\tif scenes[i].id==id then\n      i=i+1\n      i=i>#scenes and 1 or i\n      fibaro:debug(\"I:\"..i)\n      fibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",scenes[i].name..\":\"..scenes[i].id)\n      fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",scenes[i].cmds[1] or \"<NONE>\")\n      return\n    end\n  end\nend\nfibaro:debug(\"OK\")\nfibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",\"<NONE>\")\nfibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",\"<NONE>\")","buttonIcon":0,"favourite":false,"main":false},{"id":4,"lua":true,"waitForResponse":false,"caption":"Refresh","name":"Button13","empty":false,"msg":"EVC=\"EVVDVAR\"\nif not string.find(json.encode((api.get(\"/globalVariables/\"))),\"\\\"\"..EVC..\"\\\"\") then\n  api.post(\"/globalVariables/\",{name=EVC}) \nend\nselfID=fibaro:getSelfId()\nkey=\"6w8562395ue734r437fg3\"\nreq = Net.FHttp('127.0.0.1', 11111);\nscenes = req:GET(\"/api/scenes\")\nscenes=json.decode(scenes)\nres={}\nfor _,scene in pairs(scenes) do\n  id = scene.id\n  if scene.isLua then\n    --fibaro:debug(\"GET:\"..scene.name)\n    s = req:GET(\"/api/scenes/\"..id)\n    s = json.decode(s)\n    if s.lua:match(key) then\n      local cmds={}\n      evs=s.lua:match(\"--%[%[CMD(.-)%-%-%]%]\")\n      if evs and evs~=\"\" then\n        evs=evs:gsub(\"([\\r\\n]+)\",\"\\n\")\n        evs = split(evs,'\\n')\n        for i=1,#evs do\n          ecmd=evs[i]:match(\"^%s*(.-)%s*$\")\n          if ecmd~=\"\" then \n            cmds[#cmds+1]=ecmd\n          end\n        end\n      end\n      res[#res+1] = {name=s.name,id=id,cmds=cmds}\n    end     \n  end\nend\nfibaro:debug(\"Done!\")\n_,s = next(res)\nif s then\n  fibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",s.name..\":\"..s.id)\n  fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",s.cmds[1] or \"<NONE>\")\nelse\n  fibaro:call(selfID,\"setProperty\",\"ui.SCENE.value\",\"<NONE>\")\n  fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",\"<NONE>\")\nend\nfibaro:setGlobal(EVC,json.encode(res))\nfibaro:debug(fibaro:getGlobal(EVC))","buttonIcon":0,"favourite":false,"main":false}]},{"type":"label","elements":[{"id":5,"lua":false,"waitForResponse":false,"caption":"Cmd:","name":"CMD","favourite":false,"main":false}]},{"type":"button","elements":[{"id":6,"lua":true,"waitForResponse":false,"caption":"&lt;&lt;","name":"Button21","empty":false,"msg":"EVC=\"EVVDVAR\"\nselfID=fibaro:getSelfId()\nif not string.find(json.encode((api.get(\"/globalVariables/\"))),\"\\\"\"..EVC..\"\\\"\") then\n  api.post(\"/globalVariables/\",{name=EVC}) \nend\nconfig=fibaro:getGlobal(EVC)\nconfig = config or \"\"\nconfig = config~=\"\" and config or \"[]\"\n\nscenes=json.decode(config)\n\nscene = fibaro:getValue(selfID,\"ui.SCENE.value\")\ncmd = fibaro:getValue(selfID,\"ui.CMD.value\")\nif scene==\"<NONE>\" or cmd==\"<NONE>\" then return end\nid = tonumber(scene:match(\":(%d+)\"))\nfor i=1,#scenes do\n  if scenes[i].id==id then\n    cmds=scenes[i].cmds\n    for i=#cmds,1,-1 do\n      if cmds[i]==cmd then\n        i = i-1\n        i = i==0 and #cmds or i\n        fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",cmds[i])\n        return\n      end\n    end\n  end\nend\n\n","buttonIcon":0,"favourite":false,"main":false},{"id":7,"lua":true,"waitForResponse":false,"caption":"&gt;&gt;","name":"Button22","empty":false,"msg":"EVC=\"EVVDVAR\"\nselfID=fibaro:getSelfId()\nif not string.find(json.encode((api.get(\"/globalVariables/\"))),\"\\\"\"..EVC..\"\\\"\") then\n  api.post(\"/globalVariables/\",{name=EVC}) \nend\nconfig=fibaro:getGlobal(EVC)\nconfig = config or \"\"\nconfig = config~=\"\" and config or \"[]\"\n\nscenes=json.decode(config)\n\nscene = fibaro:getValue(selfID,\"ui.SCENE.value\")\ncmd = fibaro:getValue(selfID,\"ui.CMD.value\")\nif scene==\"<NONE>\" or cmd==\"<NONE>\" then return end\nid = tonumber(scene:match(\":(%d+)\"))\nfor i=1,#scenes do\n  if scenes[i].id==id then\n    cmds=scenes[i].cmds\n    for i=1,#cmds do\n      if cmds[i]==cmd then\n        i = i+1\n        i = i>#cmds and 1 or i\n        fibaro:call(selfID,\"setProperty\",\"ui.CMD.value\",cmds[i])\n        return\n      end\n    end\n  end\nend\n\n","buttonIcon":0,"favourite":false,"main":false},{"id":8,"lua":true,"waitForResponse":false,"caption":"Eval","name":"Button23","empty":false,"msg":"local selfID=fibaro:getSelfId()\nscene = fibaro:getValue(selfID,\"ui.SCENE.value\")\ncmd = fibaro:getValue(selfID,\"ui.CMD.value\")\nif scene==\"<NONE>\" or cmd==\"<NONE>\" then return end\nid = tonumber(scene:match(\":(%d+)\"))\n\nev={type='%VDEVCMD%',cmd=cmd,id=id}\nfibaro:startScene(id,{urlencode(json.encode(ev))})","buttonIcon":0,"favourite":false,"main":false}]}]},"actions":{"pressButton":1,"setSlider":2,"setProperty":2}}